AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Provisions AWS resources (NLB, VPC Endpoint Service, Route53 Resolver, NACLs) for Snowflake PrivateLink
  connectivity to an on-premise SQL Server database via Transit Gateway. Default port: 1433.
  After deployment, retrieve VpcEndpointServiceName from Outputs and provide to Snowflake Administrator.

Parameters:
  VpcId:
    Type: String
    Description: "REQUIRED: The ID of the VPC. Find in: AWS VPC Console -> Your VPCs. Example: vpc-0123456789abcdef0"
  SubnetId1:
    Type: String
    Description: "REQUIRED: The ID of the first private subnet (AZ 1). Find in: VPC Console -> Subnets. Must be in a different AZ than SubnetId2. Example: subnet-0123abc..."
  SubnetId2:
    Type: String
    Description: "REQUIRED: The ID of the second private subnet (AZ 2). Find in: VPC Console -> Subnets. Must be in a different AZ than SubnetId1. Example: subnet-0456def..."
  RouteTableId1:
    Type: String
    Description: "REQUIRED: The Route Table ID for SubnetId1. Find in: VPC Console -> Subnets -> (Select SubnetId1) -> Route Table tab. Example: rtb-0123abc..."
  RouteTableId2:
    Type: String
    Description: "REQUIRED: The Route Table ID for SubnetId2. Find in: VPC Console -> Subnets -> (Select SubnetId2) -> Route Table tab. Example: rtb-0456def..."
  OnPremDatabaseIP:
    Type: String
    Description: "REQUIRED: The private IP address of the on-premise SQL Server. Find by: Ask your Database Administrator (DBA). Example: 10.50.10.100"
  OnPremCidr:
    Type: String
    Description: "REQUIRED: The CIDR block of your on-premise network (where the database lives). Find by: Ask your Network Administrator. Example: 10.50.0.0/16"
  OnPremDomainName:
    Type: String
    Description: "REQUIRED: The internal DNS domain to forward queries to. Find by: Ask your Network Administrator. (Default is a common example)."
    Default: corp.local
  OnPremDNSServerIP1:
    Type: String
    Description: "REQUIRED: The IP address of the first on-premise DNS server (e.g., Domain Controller). Find by: Ask your Network Administrator. Example: 10.50.1.10"
  OnPremDNSServerIP2:
    Type: String
    Description: "REQUIRED: The IP address of the second on-premise DNS server. Find by: Ask your Network Administrator. Example: 10.50.1.11"
  DatabasePort:
    Type: Number
    Description: "REQUIRED: The port of the on-premise SQL Server. (Default is 1433 for SQL Server)."
    Default: 1433
  TransitGatewayId:
    Type: String
    Description: "REQUIRED: The ID of the Transit Gateway that connects this VPC to on-prem. Find in: VPC Console -> Transit Gateways. Example: tgw-0123abc..."
  SnowflakeVpcCidr:
    Type: String
    Description: "CRITICAL: The CIDR block of the Snowflake VPC. Find by: Contact Snowflake Support. This is NOT in your AWS account. Example: 54.10.0.0/24"

Resources:
  # --- 1. NLB Proxy ---
  SnowflakePrivateLinkTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: SnowflakeOnPremTargetGroup
      Port: !Ref DatabasePort
      Protocol: TCP
      VpcId: !Ref VpcId
      HealthCheckEnabled: true
      HealthCheckPort: !Ref DatabasePort
      HealthCheckProtocol: TCP
      TargetType: ip
      Targets:
        - Id: !Ref OnPremDatabaseIP

  SnowflakePrivateLinkNLB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: SnowflakeOnPremNLB
      Scheme: internal
      Type: network
      Subnets:
        - !Ref SubnetId1
        - !Ref SubnetId2

  NLBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref SnowflakePrivateLinkTargetGroup
      LoadBalancerArn: !Ref SnowflakePrivateLinkNLB
      Port: !Ref DatabasePort
      Protocol: TCP

  # --- 2. VPC Endpoint Service ---
  SnowflakeVpcEndpointService:
    Type: AWS::EC2::VPCEndpointService
    Properties:
      AcceptanceRequired: true
      NetworkLoadBalancerArns:
        - !Ref SnowflakePrivateLinkNLB

  # --- 3. Hybrid DNS ---
  ResolverOutboundEndpoint:
    Type: AWS::Route53Resolver::ResolverEndpoint
    Properties:
      Direction: OUTBOUND
      IpAddresses:
        - SubnetId: !Ref SubnetId1
        - SubnetId: !Ref SubnetId2
      SecurityGroupIds:
        - !GetAtt DnsResolverSG.GroupId
      Name: SnowflakeOnPremDnsOutboundEndpoint

  OnPremDnsForwardingRule:
    Type: AWS::Route53Resolver::ResolverRule
    Properties:
      DomainName: !Ref OnPremDomainName
      Name: OnPremDnsForwardingRule
      ResolverEndpointId: !Ref ResolverOutboundEndpoint
      RuleType: FORWARD
      TargetIps:
        - Ip: !Ref OnPremDNSServerIP1
        - Ip: !Ref OnPremDNSServerIP2

  DnsRuleAssociation:
    Type: AWS::Route53Resolver::ResolverRuleAssociation
    Properties:
      ResolverRuleId: !Ref OnPremDnsForwardingRule
      VPCId: !Ref VpcId

  DnsResolverSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref VpcId
      GroupName: SnowflakeDnsResolver-SG
      GroupDescription: Allows DNS queries to on-premise.
      SecurityGroupEgress:
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: !Sub ${OnPremDNSServerIP1}/32
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: !Sub ${OnPremDNSServerIP1}/32
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: !Sub ${OnPremDNSServerIP2}/32
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: !Sub ${OnPremDNSServerIP2}/32

  # --- 4. Network Routing (TGW) ---
  TgwRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RouteTableId1
      DestinationCidrBlock: !Ref OnPremCidr
      TransitGatewayId: !Ref TransitGatewayId

  TgwRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RouteTableId2
      DestinationCidrBlock: !Ref OnPremCidr
      TransitGatewayId: !Ref TransitGatewayId

  # --- 5. Network Security (NACLs) ---
  NaclForNlbSubnets:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VpcId
      Tags:
        - Key: Name
          Value: Snowflake-NLB-NACL

  NaclInboundFromSnowflake:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref NaclForNlbSubnets
      RuleNumber: 100
      Protocol: 6 # TCP
      RuleAction: allow
      Egress: false
      CidrBlock: !Ref SnowflakeVpcCidr
      PortRange:
        From: !Ref DatabasePort
        To: !Ref DatabasePort

  NaclInboundFromOnPrem:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref NaclForNlbSubnets
      RuleNumber: 110
      Protocol: 6 # TCP
      RuleAction: allow
      Egress: false
      CidrBlock: !Ref OnPremCidr
      PortRange:
        From: 1024
        To: 65535 # Ephemeral ports

  NaclOutboundToOnPrem:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref NaclForNlbSubnets
      RuleNumber: 100
      Protocol: 6 # TCP
      RuleAction: allow
      Egress: true
      CidrBlock: !Ref OnPremCidr
      PortRange:
        From: !Ref DatabasePort
        To: !Ref DatabasePort

  NaclOutboundToSnowflake:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref NaclForNlbSubnets
      RuleNumber: 110
      Protocol: 6 # TCP
      RuleAction: allow
      Egress: true
      CidrBlock: !Ref SnowflakeVpcCidr
      PortRange:
        From: 1024
        To: 65535 # Ephemeral ports

  NaclAssociation1:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref SubnetId1
      NetworkAclId: !Ref NaclForNlbSubnets

  NaclAssociation2:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref SubnetId2
      NetworkAclId: !Ref NaclForNlbSubnets

Outputs:
  NLBDNSName:
    Description: DNS name of the Network Load Balancer.
    Value: !GetAtt SnowflakePrivateLinkNLB.DNSName
  VpcEndpointServiceId:
    Description: The VPC Endpoint Service ID.
    Value: !Ref SnowflakeVpcEndpointService
  VpcEndpointServiceName:
    Description: "CRITICAL: The VPC Endpoint Service Name. Provide this value to your Snowflake Administrator."
    Value: !GetAtt SnowflakeVpcEndpointService.ServiceName
